#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

COMMAND=$1
case $COMMAND in
    smoke)
        set -e
        shift
        if [[ "$1" != -* ]]; then
            environment=$1
            shift
        else
            environment="staging"
        fi

        cd "$DIR/../smoketest"

        image=$(awk -F': ' '/^  newName:/ { print $2 }' \
                < k8s/base/kustomization.yaml)
        docker buildx build --output type=docker --quiet --tag $image .
        docker run --rm -it \
            -e VIVI_XMLRPC_PASSWORD=$(vault read -field password zon/v1/vivi/$environment/nightwatch) \
            -e OIDC_CLIENT_ID=edge-www \
            -e OIDC_CLIENT_SECRET=$(vault read -field client_secret zon/v1/keycloak/production/zeit-online/edge-www) \
            -e AD_CLIENT_ID=$(vault read -field client_id zon/v1/azure/activedirectory/oidc/$environment/vivi) \
            -e AD_CLIENT_SECRET=$(vault read -field client_secret zon/v1/azure/activedirectory/oidc/$environment/vivi) \
            -e AD_REFRESH_TOKEN=$(vault read -field refresh_token zon/v1/azure/activedirectory/oidc/$environment/vivi) \
            $image \
            --nightwatch-environment=$environment "$@"
        ;;
    local)
        set -e
        shift
        if [[ "$1" != -* ]]; then
            environment=$1
            shift
        else
            environment="staging"
        fi

        cd "$DIR/../smoketest"

        if [[ Pipfile.lock -nt .pipenv.success ]]; then
            pipenv sync
            touch .pipenv.success
        fi

        if ! [ -x "$(command -v yq)" ]; then
            echo 'Error: yq is not installed, install with: brew install yq.' >&2
            exit 1
        fi

        while IFS=$'\t' read -r envName vaultName vaultPath _; do
            export $envName=$(vault read -field $vaultName $vaultPath);
        done < <(yq -re '.spec.data[] | [.secretKey, .remoteRef.property, .remoteRef.key] | @tsv' k8s/base/secrets.yaml)
        export VIVI_XMLRPC_PASSWORD=$(vault read -field password zon/v1/vivi/$environment/nightwatch)
        export OIDC_CLIENT_SECRET=$(vault read -field client_secret zon/v1/keycloak/production/zeit-online/edge-www)
        export OIDC_CLIENT_ID=edge-www

        exec pipenv run pytest -c none --tb=native --nightwatch-environment=$environment "$@"
        ;;
    *)
        echo "Unrecognized command: $COMMAND"
        exit 1
    ;;
esac
