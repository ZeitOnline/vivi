#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

COMMAND=$1
case $COMMAND in
    smoke)
        set -e
        shift
        if [[ "$1" != -* ]]; then
            environment=$1
            shift
        else
            environment="staging"
        fi

        cd "$DIR/../smoketest"

        image=$(awk -F': ' '/^  newName:/ { print $2 }' \
                < k8s/base/kustomization.yaml)
        docker buildx build --output type=docker --quiet --tag $image .
        docker run --rm -it \
            $image \
            --nightwatch-environment=$environment "$@"
        ;;
    *)
        echo "Unrecognized command: $COMMAND"
        exit 1
    ;;
esac
