ZO-4104: improve error handling for can_retract, fix tests
