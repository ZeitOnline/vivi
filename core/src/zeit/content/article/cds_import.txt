CDS import
==========

Imporing content from the CDS XXX bla bla bala [#functional]_

Let's create some test data in the filestore:


>>> import zeit.content.article.cds
>>> fs = zeit.content.article.cds.get_cds_filestore('cds-import')

>>> article_xml = """\
... <?xml version="1.0" encoding="UTF-8"?>
... <article xmlns:py="http://codespeak.net/lxml/objectify/pytype">
...  <body>
...    <supertitle>Neujahrsansprache</supertitle>
...    <title>Jahr der Überraschungen</title>
...    <subtitle>
...      Kanzlerin Angela Merkel ruft die Deutschen auf, sich auch 2007 wieder
...      selbst zu überra schen. Von einer Reformpause will sie nichts wissen
...    </subtitle>
...  </body>
...  <head>
...    <attribute py:pytype="str" ns="http://namespaces.zeit.de/CMS/document"
...      name="year">2007</attribute>
...    <attribute py:pytype="str" ns="http://namespaces.zeit.de/CMS/document"
...      name="volume">2</attribute>
...    <attribute py:pytype="str" ns="http://namespaces.zeit.de/CMS/document"
...      name="text-length">2000</attribute>
...    <attribute py:pytype="str" ns="http://namespaces.zeit.de/CMS/document"
...     name="author">Dave Bowman</attribute>
...  </head>
... </article>
... """

>>> dummy = with_statement
>>> with fs.create('art1') as f:
...     f.write(article_xml)
>>> with fs.create('art2') as f:
...     f.write(article_xml.replace('2007', '2001'))
>>> with fs.create('art3') as f:
...     f.write(article_xml.replace('Kanzlerin', 'Bauerin'))

Move the created files to 'new':

>>> fs.move('art1', 'tmp', 'new')
>>> fs.move('art2', 'tmp', 'new')
>>> fs.move('art3', 'tmp', 'new')


We have data in the filestore now. Call the actual import function. It returns
True as something was imported:

>>> zeit.content.article.cds.import_one()
True

The article was created in the current online working directory (which happens
to be 2008/26):

>>> import zeit.cms.interfaces
>>> container = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/online/2008/26')
>>> article = container['art1']
>>> article.year
2007
>>> print article.title
Jahr der Überraschungen

Looking at the filestore shows us that art1 was moved to cur:

>>> sorted(fs.list('new'))
['.../art2', '.../art3']
>>> fs.list('cur')
['.../art1']

When we call ``import_one`` again it returns True for two more times:

>>> zeit.content.article.cds.import_one()
True
>>> zeit.content.article.cds.import_one()
True
>>> zeit.content.article.cds.import_one()
False

All files have been imported now:

>>> list(container)
[u'art1', u'art2', u'art3']



Runner integration
++++++++++++++++++

For the integration with gocept.runner there is a helper returning different
sleep times, depending on whether there was something imported or not. 

Add a file to the filestore again:

>>> with fs.create('art1') as f:
...     f.write(article_xml)
>>> fs.move('art1', 'tmp', 'new')

When something was imported the sleep time is low:

>>> zeit.content.article.cds.import_and_schedule()
0.02

When there was nothing imported the sleep time is higher:

>>> zeit.content.article.cds.import_and_schedule()
10


The real appmain is:

>>> zeit.content.article.cds.import_main
<function import_main at 0x...>





>>> zope.app.component.hooks.setSite(old_site)


.. [#functional]

    >>> import zope.app.component.hooks
    >>> old_site = zope.app.component.hooks.getSite()
    >>> zope.app.component.hooks.setSite(getRootFolder())

