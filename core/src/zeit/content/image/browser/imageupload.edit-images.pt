<tal:block i18n:domain="zeit.cms">
  <form action="" method="post" name="edit-images">
    <table class="edit-image-table">
      <tr><th></th><th i18n:translate="">Filename</th><th i18n:translate="">Copyright</th><th i18n:translate="">Title</th><th i18n:translate="">Caption</th></tr>
      <tr tal:repeat="item view/rows">
        <td><img tal:attributes="src item/thumbnail"><input type="hidden" tal:attributes="value item/tmp_name; name string:tmp_name[${repeat/item/index}]" /></td>
        <td>
            <input tal:attributes="value item/target_name; name string:target_name[${repeat/item/index}]" required="required">
            <div class="error" tal:condition="item/error">
                <span class="error" tal:content="item/error"></span>
            </div>
        </td>
        <td><input tal:attributes="value item/copyright; name string:copyright[${repeat/item/index}]"></td>
        <td><textarea tal:content="item/title" tal:attributes="name string:title[${repeat/item/index}]"></textarea></td>
        <td><textarea tal:content="item/caption" tal:attributes="name string:caption[${repeat/item/index}]"></textarea></td>
      </tr>
    </table>
    <p>
      <button i18n:translate="">Upload</button>
      <button name="publish" id="publishButton" i18n:translate="">Upload and publish</button>
      <button name="open" id="openButton" i18n:translate="">Upload and open</button>
    </p>
    <p>
      <button name="cancel" i18n:translate="">Remove images</button>
    </p>
  </form>
  <script>
      // Mimic core/src/zeit/content/article/edit/browser/resources/filename.js
      document.querySelector('form[name="edit-images"]').addEventListener('change', e => {
          if (e.target.name.startsWith('target_name[')) {
            e.target.value = zeit.cms.normalize_filename(e.target.value)
          }
      })

      document.getElementById('openButton')?.addEventListener('click', e => {
        e.preventDefault()
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest()
          var form = document.querySelector('form[name="edit-images"]')
          xhr.open('POST', form.action, true)
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

          xhr.onload = function() {
            if (xhr.status === 200) {
              window.location.href = xhr.responseText
              resolve()
            } else {
              reject()
            }
          }

          const formData = new FormData(form)
          formData.append('open', true)
          xhr.send(formData)
        })
      })
      document.getElementById('publishButton').addEventListener('click', e => {
        e.preventDefault()
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest()
          var form = document.querySelector('form[name="edit-images"]')
          xhr.open('POST', form.action, true)
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

          xhr.onload = function() {
            if (xhr.status === 200) {
              window.location.href = xhr.responseText
              resolve()
            } else {
              reject()
            }
          }

          const formData = new FormData(form)
          formData.append('publish', true)
          xhr.send(formData)
        })
      })
  </script>
</tal:block>
