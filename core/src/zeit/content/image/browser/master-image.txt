Master image
============

Image group can have a master image. It can be uploaded when creating the image
group[#browser]_:

>>> browser.open('http://localhost/++skin++cms/repository/2006/')
>>> menu = browser.getControl(name='add_menu')
>>> menu.displayValue = ['Image group']
>>> url = menu.value[0]
>>> browser.open(menu.value[0])

>>> browser.getControl('File name').value = 'opernball'
>>> set_file_data('opernball.jpg')
>>> browser.getControl(name='form.copyrights.0..combination_00').value = (
...     'ZEIT ONLINE')
>>> browser.getControl(name='form.copyrights.0..combination_01').value = (
...     'http://www.zeit.de/')
>>> browser.handleErrors = False
>>> browser.getControl(name='form.actions.add').click()
>>> print browser.title.strip()
opernball â€“ Image group

After uploading the overview is diplayed. The uploaded image was created:

>>> print browser.contents
<?xml...
    <td>
      opernball.jpg
    </td>
    <td>
      119x160
    </td>
    ...

It is marked as master image[#functional]_:

>>> import zope.component
>>> import zeit.cms.repository.interfaces
>>> repository = zope.component.getUtility(
...     zeit.cms.repository.interfaces.IRepository)
>>> group = repository['2006']['opernball']
>>> image = group['opernball.jpg']
>>> zeit.content.image.interfaces.IMasterImage.providedBy(image)
True

The master image marker survives checkout:

>>> import zeit.cms.checkout.interfaces
>>> checked_out = zeit.cms.checkout.interfaces.ICheckoutManager(
...     image).checkout()
>>> zeit.content.image.interfaces.IMasterImage.providedBy(checked_out)
True

... and checkin:

>>> image = zeit.cms.checkout.interfaces.ICheckinManager(checked_out).checkin()
>>> zeit.content.image.interfaces.IMasterImage.providedBy(image)
True
>>> import zeit.cms.workingcopy.interfaces
>>> zeit.cms.workingcopy.interfaces.ILocalContent.providedBy(image)
False


Clean up:

>>> zope.security.management.endInteraction()
>>> zope.app.component.hooks.setSite(old_site)


.. [#browser]

    >>> import zope.testbrowser.testing
    >>> browser = zope.testbrowser.testing.Browser()
    >>> browser.addHeader('Authorization', 'Basic user:userpw')

    >>> import os.path
    >>> def set_file_data(name):
    ...     test_file = os.path.join(
    ...         os.path.dirname(__file__), 'testdata', name)
    ...     test_data = file(test_file, 'rb')
    ...     file_control = browser.getControl(name='form.blob')
    ...     file_control.filename = name
    ...     file_control.value = test_data

.. [#functional]

    >>> import zope.app.component.hooks
    >>> old_site = zope.app.component.hooks.getSite()
    >>> zope.app.component.hooks.setSite(getRootFolder())
    >>> import zope.security.testing
    >>> principal = zope.security.testing.Principal(u'zope.user')
    >>> participation = zope.security.testing.Participation(principal)
    >>> import zope.security.management
    >>> zope.security.management.newInteraction(participation)
