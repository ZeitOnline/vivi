===========
Syndication
===========

If objects which are adaptable to IImages are syndicated, the first image will
be added to the feed.

Setup functional test:

>>> import zope.app.component.hooks
>>> old_site = zope.app.component.hooks.getSite()
>>> zope.app.component.hooks.setSite(getRootFolder())

Get a content from the repository:

>>> import zope.component
>>> import zeit.cms.repository.interfaces
>>> repository = zope.component.getUtility(
...     zeit.cms.repository.interfaces.IRepository)
>>> content = repository['testcontent']

Also create a feed:

>>> import zeit.cms.syndication.feed
>>> feed = zeit.cms.syndication.feed.Feed()

Insert content to the feed:

>>> feed.insert(0, content)

We have not added any image, so no image is referenced:

>>> print feed.xml_source
<channel xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:py="http://codespeak.net/lxml/objectify/pytype">
  <title/>
  <container>
    <block href="http://xml.zeit.de/testcontent">
      <supertitle xsi:nil="true"/>
      <title xsi:nil="true"/>
      <text xsi:nil="true"/>
      <description xsi:nil="true"/>
      <byline xsi:nil="true"/>
      <short>
        <title xsi:nil="true"/>
        <text xsi:nil="true"/>
      </short>
      <homepage>
        <title xsi:nil="true"/>
        <text xsi:nil="true"/>
      </homepage>
      <references/>
    </block>
  </container>
  <object_limit py:pytype="int">50</object_limit>
</channel>


We will mostly want to reference image groups, so create one first:

>>> import zeit.content.image.test
>>> group = zeit.content.image.test.create_image_group()

Reference the image group[#needsinteraction]_:

>>> import zeit.cms.content.interfaces
>>> import zeit.cms.checkout.interfaces
>>> import zeit.content.image.interfaces
>>> checked_out = zeit.cms.checkout.interfaces.ICheckoutManager(
...     content).checkout()
>>> images = zeit.content.image.interfaces.IImages(checked_out)
>>> images.images = (group, )
>>> content = zeit.cms.checkout.interfaces.ICheckinManager(
...     checked_out).checkin()

Update the metadata of the feed. The image is now referenced:

>>> feed.updateMetadata(content)
>>> print feed.xml_source
<channel xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:py="http://codespeak.net/lxml/objectify/pytype">
  <title/>
  <container>
    <block href="http://xml.zeit.de/testcontent">
     ...
      <image base-id="http://xml.zeit.de/image-group" type="jpg">
        <bu xsi:nil="true"/>
      </image>
    </block>
  </container>
  <object_limit py:pytype="int">50</object_limit>
</channel>

When more than one image is referenced, only the first one will be in the feed:

>>> import zope.component
>>> import zeit.cms.repository.interfaces
>>> repository = zope.component.getUtility(
...     zeit.cms.repository.interfaces.IRepository)
>>> images.images = (group, repository['2006']['DSC00109_2.JPG'],)
>>> feed.updateMetadata(content)
>>> print feed.xml_source
<channel xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:py="http://codespeak.net/lxml/objectify/pytype">
  <title/>
  <container>
    <block href="http://xml.zeit.de/testcontent">
      ...
      <image base-id="http://xml.zeit.de/image-group" type="jpg">
        <bu xsi:nil="true"/>
      </image>
    </block>
  </container>
  <object_limit py:pytype="int">50</object_limit>
</channel>


When we change the metadata of the imagegroup the content is updated on
checkin of the imagegroup. Change the metadata of the group.

Before:

>>> import lxml.etree
>>> print lxml.etree.tostring(repository['testcontent'].xml, pretty_print=True)
<testtype>
  <head>
    <image xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        base-id="http://xml.zeit.de/image-group" 
        type="jpg">
      <bu xsi:nil="true"/>
    </image>
    ...
  </head>
  <body/>
</testtype>

Now check out, change title and check in:

>>> checked_out = zeit.cms.checkout.interfaces.ICheckoutManager(
...     group).checkout()
>>> metadata = zeit.content.image.interfaces.IImageMetadata(checked_out)
>>> metadata.title = u"Image title"
>>> group = zeit.cms.checkout.interfaces.ICheckinManager(checked_out).checkin()

The content has changed automatically:

>>> print lxml.etree.tostring(
...     repository['testcontent'].xml, pretty_print=True),
<testtype>
  <head>
    <image xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" title="Image title" base-id="http://xml.zeit.de/image-group" type="jpg">
      <bu xsi:nil="true"/>
    </image>
    ...
  </head>
  <body/>
</testtype>



Reference index
===============

When an image is related to another object this is indexed. We can find this
out via the relations utility:

>>> import zeit.cms.relation.interfaces
>>> relations = zope.component.getUtility(
...     zeit.cms.relation.interfaces.IRelations)
>>> list(relations.get_relations(group, 'image_referenced_by'))
[<zeit.cms.testcontenttype.testcontenttype.TestContentType object at 0x...>]


Cleanup
=======

>>> zope.security.management.endInteraction()
>>> zope.app.component.hooks.setSite(old_site)

.. [#needsinteraction] Create interaction

    >>> import zope.publisher.browser
    >>> request = zope.publisher.browser.TestRequest()
    >>> import zope.security.testing
    >>> principal = zope.security.testing.Principal(u'zope.user')
    >>> request.setPrincipal(principal)
    >>> import zope.security.management
    >>> zope.security.management.newInteraction(request)
