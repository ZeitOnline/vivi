Brightcove in the browser
=========================

Video metadata can be edited:

>>> from z3c.etestbrowser.testing import ExtendedTestBrowser
>>> browser = ExtendedTestBrowser()
>>> browser.addHeader('Authorization', 'Basic user:userpw')
>>> browser.open(
...     'http://localhost/++skin++cms/repository-brightcove/video-1234')
>>> browser.getLink('Checkout').click()
>>> print browser.getControl('Title').value
Starrummel auf dem Roten Teppich zur 82. Oscar-Verleihung
>>> browser.getControl('Title').value = 'New title'
>>> browser.getControl('Apply', index=0).click()
>>> print browser.contents
<...
 <li class="message">Updated on ...


Edited metadata is written to brightcove:

>>> import zeit.brightcove.testing
>>> len(zeit.brightcove.testing.RequestHandler.posts_received)
1

The video was indexed:

>>> import zeit.solr.interfaces
>>> import zope.component
>>> solr = zope.component.getUtility(zeit.solr.interfaces.ISolr)
>>> solr.update_raw.called
True
>>> solr = zope.component.getUtility(zeit.solr.interfaces.ISolr, name='public')
>>> solr.update_raw.called
True

There is also a shortcurt which redirects directly after saving:

>>> browser.getControl('Title').value = 'New title 2'
>>> browser.getControl('Apply and go to search').click()
>>> print browser.contents
<...
 <li class="message">Updated on ...
>>> print browser.url
http://localhost/++skin++cms/repository/online/2008/26


The thumbnail view redirects to the url brightcove told us the thumbnail would
be:

>>> def open_wo_redirect(browser, *args, **kwargs):
...    import urllib2
...    browser.mech_browser.set_handle_redirect(False)
...    try:
...        try:
...            browser.open(*args, **kwargs)
...        except urllib2.HTTPError, e:
...            print str(e)
...            print e.hdrs.get('location')
...    finally:
...        browser.mech_browser.set_handle_redirect(True)
>>> browser.open(
...     'http://localhost/++skin++cms/repository-brightcove/video-1234/')
>>> open_wo_redirect(browser, '@@thumbnail')
HTTP Error 303: See Other
http://thumbnailurl

The absolute url of the thumbnail view is actually the thumbnail url:

>>> zeit.cms.testing.set_site()
>>> import zeit.cms.browser.interfaces
>>> import zeit.cms.interfaces
>>> import zope.publisher.browser
>>> import zope.traversing.browser.interfaces
>>> video = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/video/2010-03/1234')
>>> request = zope.publisher.browser.TestRequest(
...     skin=zeit.cms.browser.interfaces.ICMSLayer)
>>> thumbnail_view = zope.component.getMultiAdapter(
...     (video, request), name='thumbnail')
>>> print zope.component.getMultiAdapter(
...     (thumbnail_view, request),
...     zope.traversing.browser.interfaces.IAbsoluteURL)()
http://thumbnailurl


The video still url is exposed as preview:

>>> view = zope.component.getMultiAdapter(
...     (video, request), name='preview')
>>> print zope.component.getMultiAdapter(
...     (view, request),
...     zope.traversing.browser.interfaces.IAbsoluteURL)()
http://videostillurl

Playlists information is visible:

>>> browser.open(
...     'http://localhost/++skin++cms/repository-brightcove/playlist-2345')
>>> print browser.contents
<...
   <label for="form.__name__">
           <span>File name</span>
         </label>...
        <div class="widget">playlist-2345</div>...

The live and preview link redirect to the video page:

>>> browser.open(
...     'http://localhost/++skin++cms/repository-brightcove/video-1234')
>>> zeit.cms.testing.click_wo_redirect(browser, 'Preview')
HTTP Error 303: See Other
http://xml.zeit.de/video/2010-03/1234
>>> browser.open(
...     'http://localhost/++skin++cms/repository-brightcove/video-1234')
>>> zeit.cms.testing.click_wo_redirect(browser, 'Live')
HTTP Error 303: See Other
http://xml.zeit.de/video/2010-03/1234
