=========
XML tests
=========


Mapping of DAV properties to xml
================================

A content which implements IDAVPropertiesInXML will have it's webdav properties
mapped to xml on change, checkin, checkout.

Create a content class. The content class must provide IDAVPropertiesInXML for
the event handlers to do something. It also needs to be adaptable to or provide
directly IXMLRepresentation.

>>> import lxml.objectify
>>> import lxml.etree
>>> import zope.interface
>>> import zeit.cms.content.dav
>>> import zeit.cms.content.interfaces
>>> class Content(object):
...     zope.interface.implements(
...         zeit.cms.content.interfaces.IXMLRepresentation,
...         zeit.cms.content.interfaces.IDAVPropertiesInXML)
...     xml = lxml.objectify.fromstring('<a/>')
...     title = zeit.cms.content.dav.DAVProperty(
...         zope.schema.TextLine(), 'myns', 'title')
...
...     def __init__(self):
...         self.properties = {}
...

Set security:

>>> import zope.app.security.protectclass
>>> zope.app.security.protectclass.protectName(Content, 'xml', 'zope.Public')
>>> zope.app.security.protectclass.protectSetAttribute(
...     Content, 'xml', 'zope.Public')

We need an adapter for the webdav properties:

>>> import zope.component
>>> gsm = zope.component.getGlobalSiteManager()
>>> def contentDavProps(context):
...     return context.properties
>>> gsm.registerAdapter(
...     contentDavProps,
...     (Content, ), zeit.cms.interfaces.IWebDAVProperties)

>>> content = Content()


Update on property change
=========================

When we set the title, an IDAVPropertyChangedEvent is issued. Thus the xml will
change and contain the property:

>>> content.title = u'Mary had a little lamb.'
>>> print lxml.etree.tostring(content.xml, pretty_print=True)
<a>
  <head>
    <attribute
      xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" 
      ns="myns" name="title">Mary had a little lamb.</attribute>
  </head>
</a>


Setting the value to None, which is the default of the field, will remove the
property:

>>> content.title = None
>>> print lxml.etree.tostring(content.xml, pretty_print=True)
<a>
  <head/>
</a>


Checkin handler
===============

The checkin handler copies all webdav properties to the xml *before* the object
is checked in. It removes all existing head.attribute nodes before adding the
properties. Add some attributes to make sure they're removed:

>>> content.xml = lxml.objectify.XML(u"""\
...     <a>
...      <head>
...        <attribute xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" ns="some-namespace" name="somename">somevalue</attribute>
...        <attribute xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" ns="some-namespace" name="some-other-name">someothervalue</attribute>
...      </head>
...    </a>""")


Let's add some properties under the hood. Note thad properties in the DAV:
namespace are *not* mapped:

>>> import zeit.connector.interfaces
>>> properties = zeit.connector.interfaces.IWebDAVProperties(content)
>>> properties[('am-i', 'under-the-hood')] = '4711'
>>> properties[('foobar', 'DAV:')] = 'no-dav-sync'
>>> print lxml.etree.tostring(content.xml, pretty_print=True)
<a>
  <head>
    <attribute xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" ns="some-namespace" name="somename">somevalue</attribute>
    <attribute xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" ns="some-namespace" name="some-other-name">someothervalue</attribute>
  </head>
</a>


When an IBeforeCheckinEvent is sent the xml is updated:

>>> import zope.event
>>> import zeit.cms.checkout.interfaces
>>> zope.event.notify(zeit.cms.checkout.interfaces.BeforeCheckinEvent(
...     content, None))
>>> print lxml.etree.tostring(content.xml, pretty_print=True)
<a>
  <head>
    <attribute xmlns:py="http://codespeak.net/lxml/objectify/pytype" py:pytype="str" ns="under-the-hood" name="am-i">4711</attribute>
  </head>
</a>



Clean up:

>>> gsm.unregisterAdapter(
...     contentDavProps,
...     (Content, ), zeit.cms.interfaces.IWebDAVProperties)
True
