===============
 UUID handling
===============

>>> from zeit.connector.interfaces import UUID_PROPERTY
>>> import os
>>> import StringIO
>>> import zeit.connector.connector
>>> import zeit.connector.resource
>>> connector = zeit.connector.connector.Connector(roots={
...       "default": os.environ['connector-url']})

UUIDs are generated by the DAV server by default:

>>> res = zeit.connector.resource.Resource(
...     'http://xml.zeit.de/testing/uuid', 'uuid', 'text',
...     StringIO.StringIO('Pop goes the weasel!'),
...     contentType='text/plain')
>>> print res.properties.get(UUID_PROPERTY)
None
>>> connector.add(res)
>>> res = connector[res.id]
>>> uuid = res.properties[UUID_PROPERTY]
>>> uuid
'{urn:uuid:...}'

Changing the property does not have any effect:

>>> connector.changeProperties(
...     res.id, {UUID_PROPERTY: '{urn:uuid:foo}'})
>>> res = connector[res.id]
>>> res.properties[UUID_PROPERTY] == uuid
True

Adding the same resource with the same UUID again works silently:

>>> connector.add(res)
>>> res = connector[res.id]
>>> res.properties[UUID_PROPERTY] == uuid
True

But trying to add the same resource with a different UUID fails:

>>> uuid = '{urn:uuid:42d5d75c-25fc-424d-904a-a61b02bc0439}'
>>> res = zeit.connector.resource.Resource(
...     'http://xml.zeit.de/testing/uuid', 'uuid', 'text',
...     StringIO.StringIO('Pop goes the weasel!'),
...     contentType='text/plain')
>>> res.properties[UUID_PROPERTY] = uuid
>>> connector.add(res)
Traceback (most recent call last):
...
HTTPException: (409, 'Conflict'...

When the resource does not exist, the UUID can be defined by the client by
setting the property:

>>> res = zeit.connector.resource.Resource(
...     'http://xml.zeit.de/testing/uuid2', 'uuid2', 'text',
...     StringIO.StringIO('Pop goes the weasel!'),
...     contentType='text/plain')
>>> res.properties[UUID_PROPERTY] = uuid
>>> connector.add(res)
>>> res = connector[res.id]
>>> res.properties[UUID_PROPERTY] == uuid
True
