Long running transactions
=========================

Let's test the behaviour of long running transactions. That is we do something
with the connector, wait quite a while and continue. This used to yield
BadStatusLine errors.

>>> import os
>>> from zeit.connector.connector import Connector
>>> connector = Connector(roots={
...       "default": os.environ['connector-url']})


Enable debugging of the http data:

>>> import zeit.connector.dav.davbase
>>> zeit.connector.dav.davbase.DEBUG_CONNECTION = True


Remember the connection for later:

>>> connection = connector.get_connection()._con

Get a list:

>>> list(connector.listCollection('http://xml.zeit.de/testing/'))
send: 'HEAD /cms/work/testing HTTP/1.1\r\nAccept-Encoding: identity\r\nHost: zip6.zeit.de:9000\r\nConnection: keep-alive\r\nUser-Agent: zeit.connector\r\n\r\n'
reply: 'HTTP/1.1 301 Moved Permanently\r\n'
header: Date: ...
header: Server: ...
header: Location: http://zip6.zeit.de:9000/cms/work/testing/
header: Keep-Alive: timeout=15, max=...
header: Connection: Keep-Alive
header: Content-Type: text/html; charset=iso-8859-1
send: 'PROPFIND /cms/work/testing/ HTTP/1.1\r\nAccept-Encoding: identity\r\nContent-Length: 99\r\nDepth: 1\r\nConnection: keep-alive\r\nContent-Type: text/xml; charset="utf-8"\r\nHost: zip6.zeit.de:9000\r\nUser-Agent: zeit.connector\r\n\r\n'
send: '<?xml version=\'1.0\' encoding=\'UTF-8\'?>\n<ns0:propfind xmlns:ns0="DAV:"><ns0:allprop/></ns0:propfind>'
reply: 'HTTP/1.1 207 Multi-Status\r\n'
header: Date: ...
header: Server: ...
header: MS-Author-Via: DAV
header: Content-Length: 914
header: Keep-Alive: timeout=15, max=...
header: Connection: Keep-Alive
header: Content-Type: text/xml; charset="utf-8"
[]


So apparently we may only wait 15 seconds before the connection will time out.
In this case we will silently reconnect. The first HEAD request does not reach
the server, then the reconnect happens and the HEAD request is send again:

>>> import time
>>> time.sleep(16)
>>> connector._invalidate_cache('http://xml.zeit.de/testing/')
send: 'HEAD /cms/work/testing HTTP/1.1\r\nAccept-Encoding: identity\r\nHost: zip6.zeit.de:9000\r\nConnection: keep-alive\r\nUser-Agent: zeit.connector\r\n\r\n'
reply: ''
send: 'HEAD /cms/work/testing HTTP/1.1\r\nAccept-Encoding: identity\r\nHost: zip6.zeit.de:9000\r\nConnection: keep-alive\r\nUser-Agent: zeit.connector\r\n\r\n'
reply: 'HTTP/1.1 301 Moved Permanently\r\n'
header: Date: ...
header: Server: ...
header: Location: http://zip6.zeit.de:9000/cms/work/testing/
header: Keep-Alive: timeout=15, max=...
header: Connection: Keep-Alive
header: Content-Type: text/html; charset=iso-8859-1
send: 'PROPFIND /cms/work/testing/ HTTP/1.1\r\nAccept-Encoding: identity\r\nContent-Length: 99\r\nDepth: 1\r\nConnection: keep-alive\r\nContent-Type: text/xml; charset="utf-8"\r\nHost: zip6.zeit.de:9000\r\nUser-Agent: zeit.connector\r\n\r\n'
send: '<?xml version=\'1.0\' encoding=\'UTF-8\'?>\n<ns0:propfind xmlns:ns0="DAV:"><ns0:allprop/></ns0:propfind>'
reply: 'HTTP/1.1 207 Multi-Status\r\n'
header: Date: ...
header: Server: ...
header: MS-Author-Via: DAV
header: Content-Length: 914
header: Keep-Alive: timeout=15, max=...
header: Connection: Keep-Alive
header: Content-Type: text/xml; charset="utf-8"
>>> list(connector.listCollection('http://xml.zeit.de/testing/'))
[]


We really have reconnected (see also the connect: (...) above):

>>> connection == connector.get_connection()._con
False

Clean up:

>>> zeit.connector.dav.davbase.DEBUG_CONNECTION = False
